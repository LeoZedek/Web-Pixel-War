<!DOCTYPE html>
<html lang="en">

<head>
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/vue.js"></script>
    <script src="assets/js/plotly-2.16.1.min.js"></script>

    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/profil_user.css">
    <link rel="stylesheet" media="screen" href="https://fontlibrary.org//face/minecraftia" type="text/css"/>

    <title>User profile</title>
</head>

<body>

    <%- include('navbar.ejs', {connected: connected, pseudo : pseudo, room : room}) %>


    <div id = "app">

        <div class="cadre">
                <h2 class="titre_cadre">Informations</h2>
                <img id="avatar" v-bind:src="avatarPath" class="image">
                <br>
                <div class="ligne_texte">
                    Status : {{vipLevel}}
                </div>
                <div class="ligne_texte">
                    Username :
                    <input type="text" class="new_pseudo" placeholder="new pseudo" v-model="pseudo" required>
                </div>
                <div class="ligne_texte">
                    Password : 
                    <input type="password" class="new_password" placeholder="new password" v-model="pwdHash" required>
                </div>
                <div class="ligne_texte"> 
                    <input type="button" class="bouton" v-on:click="update_profil()" value="Edit my info">
                </div>
        </div>

        <div class="cadre">
            <h2 class="titre_cadre"> Statistics</h2>

            <div class="ligne_texte">Number of pixels added : {{number_modifications}}</div>
            <div class="ligne_texte">Colored pixels :</div>
            <div id = "histogram"></div>
        </div>
    </div>
    

    <script type="text/javascript">
        // Auteur de la balise script : LÃ©o Zedek


        function color_stats_string_to_json(color_stats) {
            const colors = color_stats.split(",");
            const result = {};

            for (index in colors) {
                const color = colors[index].split(":");

                const id_color = color[0];
                const number_color = color[1];

                result[id_color] = number_color;

            }

            return result;
        }
        
        // Get ESJ variable
        let id_user = '<%= id_user%>';

        const app = new Vue({
            el:"#app",
            data: {
                number_modifications: null,
                pseudo: "",
                pwdHash : "",
                vipLevel : "",
                avatarPath : "assets/img/avatar_0.png",
            },

            methods: {
                update_profil() {
                    
                    if (app._data.pwdHash != ''){
                        $.ajax({ 
                        type: "POST",
                        url: "/user_statistics/update_profil",
                        data: {
                            id_user : id_user,
                            new_pseudo : app._data.pseudo,
                            new_password : app._data.pwdHash
                        },
                        success: function(received_data) {
                            alert("Profile updated successfully !");
                        },
                        error: function() {
                            alert("Error during updating profile");
                        }
                    });
                    }
                    alert("New password mustn't be empty !");
                    

                }
            },
        });

        const vip_level_name = {
            0 : "Normal user",
            1 : "VIP user",
        };

        // AJAX request to get all the statistics of the user.
        $.ajax({
            type: "POST",
            url: "/user_statistics/get_statistics",
            data : {id : id_user},
            success: function(received_data) {
                app._data.pseudo = received_data["pseudo"];
                //app._data.pwdHash = received_data["pwd_hash"];
                app._data.number_modifications = received_data["nb_modif"];
                app._data.vipLevel = vip_level_name[received_data["vip_level"]];

                app._data.avatarPath = "assets/img/avatar_" + received_data["avatar_id"] + ".png";

                let color_stats = color_stats_string_to_json(received_data["color_stats"]);
                let colors_code_by_id = received_data["colors"];

                let numbers = [];
                let colors_code = [];
                let colors_name = [];

                for (id_color in color_stats) {
                    let number_color = color_stats[id_color];

                    if (number_color > 0) {
                        numbers.push(number_color);
                        colors_code.push(colors_code_by_id[id_color]);
                        colors_name.push("Color " + colors_code_by_id[id_color]);
                    }


                }

                let data = [
                    {
                        histfunc : "sum",
                        y : numbers,
                        x : colors_name,
                        type : "histogram",
                        marker : {
                            color : colors_code,
                            line : {
                                width : 1,
                                color : "black",
                            }
                        },
                    },
                ];

                let layout = {};

                Plotly.newPlot("histogram", data, layout, {staticPlot: true});

                
            },
            error: function() {
              console.log("Error AJAX");
            }
          });

    </script>

</body>

</html>